---
owner: bonginkan_oka
updated: 2026-02-14
staleness_days: 60
breaks_build_if_stale: false
watch_paths:
  - src/
  - Cargo.toml
  - Cargo.lock
spec_needs_review:
  - section: "3. 機能詳細"
    reason: "Phase D〜F実装完了: ディレクトリツリー、ファイルプレビュー、br連携、入力履歴、エラー処理改善"
    detected: 2026-02-14
  - section: "5. 重要機能の契約定義"
    reason: "エラー処理改善: claude未インストール検知、ディレクトリ不在検証"
    detected: 2026-02-14
  - section: "9. ユーザーインターフェース"
    reason: "DirTreeパネル・FilePreviewパネルの実装完了、入力履歴のUp/Down操作追加"
    detected: 2026-02-14
  - section: "11. 外部サービス境界"
    reason: "br CLI連携（br list --json --all）による3秒間隔ポーリング追加"
    detected: 2026-02-14
  - section: "12. 非機能要件"
    reason: "パニックフック追加（ターミナル復帰保証）"
    detected: 2026-02-14
  - section: "14. 品質保証"
    reason: "テストケース追加: 39テスト（dir_tree 6件、file_preview 5件、br_poller 4件、input_history 4件）"
    detected: 2026-02-14
  - section: "9. ユーザーインターフェース"
    reason: "ステータスバーにコンテキスト別キーヒント表示を追加（フォーカス中パネルに応じて動的切替）"
    detected: 2026-02-15
---

# 基本設計書：deck

**バージョン**: 0.1.0（設計フェーズ版）
**作成日**: 2026年02月14日
**ステータス**: 設計フェーズ（実装前。コードベースとの突合は実装完了後に実施）

---

## 目次

1. [設計概要](#1-設計概要)
2. [システム構成](#2-システム構成)
3. [機能詳細](#3-機能詳細)
4. [納品の定義](#4-納品の定義)
5. [重要機能の契約定義](#5-重要機能の契約定義)
6. [データフロー](#6-データフロー)
7. [状態遷移](#7-状態遷移)
8. [データ保存](#8-データ保存)
9. [ユーザーインターフェース](#9-ユーザーインターフェース)
10. [セキュリティ・プライバシー](#10-セキュリティプライバシー)
11. [外部サービス境界](#11-外部サービス境界)
12. [非機能要件](#12-非機能要件)
13. [監視・障害対応](#13-監視障害対応)
14. [品質保証](#14-品質保証)
15. [納品物一覧・検収観点](#15-納品物一覧検収観点)
16. [運用・保守](#16-運用保守)
17. [運用コスト概要](#17-運用コスト概要)
18. [変更管理](#18-変更管理)
19. [変更履歴](#19-変更履歴)

---

## 1. 設計概要

### 1-1. システムの目的

deck は、複数の Claude Code セッションを1つの画面で統合管理するターミナルアプリケーション（TUI）である。

開発者が複数のタスクを並行して Claude Code に実行させる際、以下の課題を解決する。

| 課題 | deck による解決 |
| :-- | :-- |
| 複数ターミナルを行き来する煩雑さ | 1画面で全セッションを一覧表示し、瞬時に切り替え |
| セッションの状態が把握しにくい | ステータスバーで全セッションの状態を常時表示 |
| Claude Code の確認待ちを見逃す | 入力待ち状態を自動検知し、視覚的に通知 |
| 作業ファイルの確認に画面切替が必要 | ディレクトリツリーとファイルプレビューを内蔵 |
| ログが散逸する | セッションごとにログを自動保存、統合表示も可能 |

### 1-2. コンセプト

- **指示・監視・介入に特化する** — 計画作成は外部エディタに委ねる
- **安全性優先** — 自動応答による確認突破は行わない。入力待ちで停止して人が判断する
- **読み取り専用連携** — br（beads_rust: タスク管理ツール）のデータは表示のみ。書き込みはしない

### 1-3. 対象ユーザー

Claude Code を日常的に使用し、複数タスクを並行実行する開発者。

### 1-4. スコープ

**対象範囲:**

- 複数セッションの作成・削除・切替・名前変更
- PTY（仮想端末）経由での Claude Code 起動と指示送信
- ログのリアルタイム表示（統合 / 個別切替）
- セッション状態の自動検知と表示
- ディレクトリツリー表示とファイルプレビュー
- br タスク進捗の補助表示（読み取り専用）
- セッション情報とログの永続化

**対象外（明示的に除外）:**

- アプリ内でのプラン作成・編集 UI
- アプリ内での br タスクのインライン編集 UI
- スケジュール自動実行
- 自動応答による確認待ち突破
- Git GUI 操作パネル

---

## 2. システム構成

### 2-1. 技術スタック

| 要素 | 技術 | 備考 |
| :-- | :-- | :-- |
| 言語 | Rust（nightly toolchain） | FrankenTUI が nightly を要求 |
| TUI フレームワーク | FrankenTUI | Elm/Bubbletea 型アーキテクチャ |
| 実行環境 | macOS / Linux ターミナル | ローカル実行のみ |
| データ保存 | JSON（構造化テキスト形式）ファイル + テキストログ | 外部 DB 不使用 |

### 2-2. 主要クレート構成

| クレート | 用途 |
| :-- | :-- |
| ftui | 公開ファサード（一括インポート用） |
| ftui-core | ターミナルの起動・終了、キーイベント取得 |
| ftui-render | 画面バッファの差分計算と描画 |
| ftui-runtime | イベントループ（Model-Update-View パターン） |
| ftui-widgets | 一覧、ツリー、テキスト表示、入力欄等の部品 |
| ftui-layout | 画面分割のレイアウト計算 |
| ftui-style | 色やスタイルの管理 |
| ftui-pty | 仮想端末（PTY）プロセスの管理 |

### 2-3. アーキテクチャ概要

Model-Update-View パターンを採用する。

```
イベント発生（キー入力、PTY出力、タイマー、brポーリング結果）
  ↓
メッセージに変換（型安全な列挙型）
  ↓
update()：状態を更新し、副作用を返す
  ↓
view()：状態から画面を描画（状態は読み取り専用）
  ↓
差分だけを端末に出力
```

### 2-4. 外部依存

| 依存先 | 種類 | 必須/任意 |
| :-- | :-- | :-- |
| Claude Code CLI（`claude` コマンド） | コマンドラインツール | 必須 |
| br（beads_rust） | コマンドラインツール | 任意（タスク進捗表示に使用） |
| $EDITOR（vim 等） | テキストエディタ | 任意（ファイル編集時に使用） |
| Rust nightly toolchain | ビルド環境 | 必須（ビルド時のみ） |

---

## 3. 機能詳細

### 機能一覧

| ID | 機能名 | 概要 |
| :-- | :-- | :-- |
| F-01 | セッション管理 | 複数の Claude Code セッションを作成・削除・切替・名前変更する |
| F-02 | PTY 実行 | 仮想端末で Claude Code を起動し、指示を送信・出力を受信する |
| F-03 | 入力待ち検知 | Claude Code が確認入力を求めている状態を検知し通知する |
| F-04 | ログ表示 | セッションの出力を統合または個別にリアルタイム表示する |
| F-05 | ディレクトリ探索 | セッションの作業ディレクトリをツリー表示し、ファイルをプレビューする |
| F-06 | br 連携表示 | br タスクの進捗をセッション一覧に補助表示する（読み取り専用） |
| F-07 | セッション永続化 | セッション情報とログをファイルに保存し、再起動後も復元する |
| F-08 | ステータスバー | 全セッションの状態集計を画面最下部に常時表示する |

---

## 4. 納品の定義

以下の5条件を**すべて**満たした時点で MVP 完成とする。

1. セッションを3つ以上同時に作成し、それぞれに独立した指示を送信できる
2. 全セッションの状態（実行中・待機・完了・エラー・入力待ち）がステータスバーに表示され、状態変化から1秒以内に反映される
3. セッション切替時に、ログ表示・ディレクトリツリー・ファイルプレビューが選択セッションに連動して切り替わる
4. Claude Code の確認待ち（y/n プロンプト等）を検知し、入力待ち状態に遷移する。自動応答は行わない
5. アプリを終了して再起動した後、セッション一覧とログが復元される（PTY プロセスは再接続不可のため待機状態にリセット）

---

## 5. 重要機能の契約定義

### F-02: PTY 実行

#### 1. 目的

仮想端末（PTY: ターミナルを仮想的に作る仕組み）を介して Claude Code を起動し、ユーザーの指示をそのまま送信し、出力をリアルタイムで受信する。

#### 2. 実行者と権限

アプリを起動したユーザー（OS のユーザー権限で動作する）。

#### 3. 入力

- セッションの作業ディレクトリ（PTY の起動先）
- ユーザーが入力欄に入力した指示テキスト

#### 4. 出力

- Claude Code の標準出力・標準エラー出力（ANSI カラーコード（端末の色付け制御文字）含む）
- プロセス終了コード（正常終了: 0、異常終了: 0以外）

#### 5. 前提条件

- `claude` コマンドがシステムの PATH に存在すること
- 指定した作業ディレクトリが存在すること

#### 6. 正常系

1. セッションを選択し、指示を入力して Enter を押す
2. PTY が作成され、指定ディレクトリで `claude` コマンドが起動する
3. 指示テキストが PTY に書き込まれる
4. Claude Code の出力がログパネルにリアルタイム表示される
5. 出力は同時にログファイルに追記される
6. Claude Code がタスク完了して終了すると、終了コード 0 でセッション状態が「完了」に遷移する

#### 7. 例外系

| 条件 | 挙動 |
| :-- | :-- |
| `claude` コマンドが未インストール | セッション状態を「失敗」に変更し、ログに「claude コマンドが見つかりません」と表示する |
| 作業ディレクトリが存在しない | セッション状態を「失敗」に変更し、ログに「ディレクトリが存在しません: {パス}」と表示する |
| PTY プロセスが異常終了（終了コード ≠ 0） | セッション状態を「失敗」に変更し、終了コードをログに記録する |
| PTY プロセスが SIGKILL（強制終了シグナル）で強制終了された | セッション状態を「失敗」に変更し、「プロセスが強制終了されました」とログに表示する |

#### 8. データ更新点

- セッションの status フィールド（queued → running → done / failed）
- セッションの pty_pid フィールド（起動時に設定、終了時に null）
- セッションの exit_code フィールド（終了時に設定）
- ログファイル（PTY 出力を追記）

#### 9. 受入条件（合否判定）

- 指示入力欄に「echo hello」と入力して Enter を押すと、ログパネルに Claude Code の応答が表示される
- PTY プロセスが終了コード 0 で終了した場合、セッション状態が「完了」に変わる
- PTY プロセスが終了コード 1 で終了した場合、セッション状態が「失敗」に変わる
- `claude` コマンドが PATH にない環境で PTY 起動を試みると、ログに「claude コマンドが見つかりません」が表示される
- Ctrl+C を押すと、選択中セッションの PTY プロセスに SIGINT（中断シグナル）が送信される

---

### F-03: 入力待ち検知

#### 1. 目的

Claude Code が人間の確認入力を必要としている状態（y/n プロンプトなど）を検知し、ユーザーに通知する。自動応答は行わない。

#### 2. 実行者と権限

アプリが自動的に検知する。ユーザー操作は不要（手動切替も可能）。

#### 3. 入力

- PTY からのストリーム出力テキスト
- 設定値: needs_input_timeout_sec（出力停止のタイムアウト秒数。デフォルト: 30秒）

#### 4. 出力

- セッション状態の「入力待ち」への遷移
- ステータスバーの入力待ちカウント更新
- セッション一覧のアイコン変化（◆ マーク）

#### 5. 前提条件

- セッションが「実行中」状態であること

#### 6. 正常系（自動検知）

1. PTY 出力に確認パターン（y/n, confirm, continue 等）を含むテキストが出現する
2. アプリがパターンマッチで検知する
3. セッション状態を「入力待ち」に遷移する
4. ステータスバーの入力待ちカウントが +1 される
5. セッション一覧のアイコンが ◆ に変わる
6. ユーザーが入力欄から回答を入力すると「実行中」に復帰する

#### 6-b. 正常系（タイムアウト検知）

1. PTY 出力が needs_input_timeout_sec 秒間（デフォルト30秒）停止する
2. アプリがタイムアウトを検知する
3. セッション状態を「入力待ち」に遷移する

#### 6-c. 正常系（手動切替）

1. ユーザーが m キーを押す
2. 選択中セッションの状態を「入力待ち」に切り替える

#### 7. 例外系

| 条件 | 挙動 |
| :-- | :-- |
| パターンマッチの誤検知（実際には入力を求めていない） | ユーザーが通常の指示を入力すれば、そのまま PTY に送信されて「実行中」に復帰する。安全側に倒す設計のため、誤検知は許容する |
| 入力待ち中に PTY プロセスが終了した | 終了コードに応じて「完了」または「失敗」に遷移する（入力待ちより終了が優先） |

#### 8. データ更新点

- セッションの status フィールド（running → needs_input）

#### 9. 受入条件（合否判定）

- PTY 出力に「(y/n)」を含むテキストが出現した場合、セッション状態が「入力待ち」に変わる
- PTY 出力が30秒間（デフォルト設定時）停止した場合、セッション状態が「入力待ち」に変わる
- m キーを押すと、選択中セッションの状態が「入力待ち」に切り替わる
- 入力待ち状態で指示を入力して Enter を押すと、セッション状態が「実行中」に復帰する
- 入力待ちアイコン（◆）がセッション一覧に表示される

---

### F-01: セッション管理

#### 1. 目的

複数の Claude Code セッションを作成・削除・名前変更・切替する。

#### 2. 実行者と権限

アプリを起動したユーザー。

#### 3. 入力

- 新規作成時: セッション名（任意）、作業ディレクトリパス（必須）
- 削除時: 対象セッションの選択
- 名前変更時: 新しいセッション名

#### 4. 出力

- セッション一覧の更新
- sessions.json への保存

#### 5. 前提条件

なし（アプリ起動直後から操作可能）。

#### 6. 正常系

| 操作 | キー | 動作 |
| :-- | :-- | :-- |
| セッション作成 | n | 名前と作業ディレクトリを指定して新規セッション作成。名前省略時は session-1, session-2... と自動採番 |
| セッション削除 | d | 確認ダイアログ表示後、選択中セッションを削除。実行中の場合は PTY プロセスも終了 |
| セッション名変更 | r | 入力欄にフォーカスが移り、新しい名前を入力 |
| セッション選択 | ↑↓ | 上下キーでセッション切替。ログ・ディレクトリツリー・ファイルプレビューが連動 |

#### 7. 例外系

| 条件 | 挙動 |
| :-- | :-- |
| 指定した作業ディレクトリが存在しない | セッション作成を中止し、エラーメッセージを表示する |
| セッション名が空文字 | 自動採番名を割り当てる |
| 実行中セッションの削除 | 確認ダイアログに「実行中のセッションです。PTY プロセスも終了します。」と追記して表示する |

#### 8. データ更新点

- sessions.json（セッション追加 / 削除 / 名前変更）
- ログファイル（セッション削除時は保持。手動削除とする）

#### 9. 受入条件（合否判定）

- n キーを押してセッション名と作業ディレクトリを入力すると、セッション一覧に新しいセッションが追加される
- d キーを押すと確認ダイアログが表示され、承認するとセッションが一覧から削除される
- r キーを押して新しい名前を入力すると、セッション名が変更される
- ↑↓キーでセッションを選択すると、ログパネルが選択セッションのログに切り替わる

---

### その他の機能（要約）

| ID | 機能名 | 入力 | 出力 | 受入条件 |
| :-- | :-- | :-- | :-- | :-- |
| F-04 | ログ表示 | PTY 出力ストリーム | ログパネルへの表示 + ログファイルへの保存 | Tab キーで統合/個別ログが切り替わる。/ キーでログ内文字列検索ができる。PTY 出力に含まれる色付きテキストがログパネルに色付きで表示される（ANSI エスケープシーケンスが解釈される） |
| F-05 | ディレクトリ探索 | セッションの作業ディレクトリ | ツリー表示 + ファイルプレビュー | Enter でフォルダが展開される。ファイル選択で中央パネルに内容が表示される。e キーで $EDITOR が起動する。h キーで隠しファイル表示がトグルする |
| F-06 | br 連携表示 | br list --json の出力 | セッション名横の「[3/8 tasks]」表示 | .beads/ が存在するディレクトリのセッションに、br タスク件数が表示される。.beads/ が存在しないディレクトリのセッションには表示されない |
| F-07 | セッション永続化 | セッション状態 | sessions.json + ログファイル | アプリ終了後に再起動すると、セッション一覧が復元される。PTY プロセスは「待機」状態にリセットされる。ログファイルは保持される |
| F-08 | ステータスバー | 全セッションの状態 | 状態別カウント表示 | 画面最下部に「実行中: N │ 待機: N │ 完了: N │ エラー: N │ 入力待ち: N」が表示される。セッション状態の変化から1秒以内に更新される |

---

## 6. データフロー

### 全体フロー

```
[外部エディタ]          [deck（TUIアプリ）]           [PTY: Claude Code]    [br DB]
    │                        │                            │                   │
    │ プランファイルを作成     │                            │                   │
    │                        │                            │                   │
    │                   セッション作成                      │                   │
    │                   作業ディレクトリ指定                │                   │
    │                        │                            │                   │
    │                   指示入力:                           │                   │
    │                   「タスクを実行して」                 │                   │
    │                        ├── PTY 書き込み ───────────→│                   │
    │                        │                            │── タスク実行 ───→│
    │                        │                            │                   │ 更新
    │                        │←── ログ表示 ←──────────────│                   │
    │                        │                            │                   │
    │                        │←── br list（3秒間隔読取）──────────────────←│
    │                        │    [3/8 tasks] 表示         │                   │
    │                        │                            │                   │
    │                   入力待ち検知                        │                   │
    │                   → ステータスバー更新                │                   │
    │                   → ユーザーが回答入力                │                   │
    │                        ├── PTY 書き込み ───────────→│                   │
```

### データの流れの要点

1. **deck → Claude Code**: ユーザーの指示テキストを PTY 経由で送信（一方向）
2. **Claude Code → deck**: PTY 出力をストリームで受信しログに表示・保存（一方向）
3. **br DB → deck**: 3秒間隔で `br list --json` を実行し、タスク進捗を読み取り表示（読み取り専用）
4. **deck → sessions.json**: セッション情報の永続化（アプリ管理）
5. **deck → ログファイル**: PTY 出力の永続化（セッションごとに1ファイル）

---

## 7. 状態遷移

### セッション状態

| 状態 | アイコン | 意味 |
| :-- | :-- | :-- |
| queued（待機） | ○ | PTY 未起動。指示待ち |
| running（実行中） | ● | PTY プロセスあり。出力流れ中 |
| needs_input（入力待ち） | ◆ | 人の入力を必要としている（停止検知） |
| done（完了） | ✓ | PTY プロセス正常終了（終了コード 0） |
| failed（失敗） | ✗ | PTY プロセス異常終了（終了コード ≠ 0） |

### 遷移条件

| 遷移元 | 遷移先 | 条件 |
| :-- | :-- | :-- |
| queued | running | PTY 起動 + 指示送信 |
| running | done | PTY プロセスが終了コード 0 で終了 |
| running | failed | PTY プロセスが終了コード 0 以外で終了 |
| running | needs_input | 確認パターン検知、タイムアウト検知、または手動切替（m キー） |
| needs_input | running | ユーザーが入力欄から回答を送信 |
| failed | running | ユーザーが再実行（同セッションで PTY を再起動） |
| done | queued | 次の指示を待つ状態にリセット |

### 禁止遷移

| 遷移 | 理由 |
| :-- | :-- |
| queued → done | PTY を起動せずに完了にはできない |
| queued → needs_input | PTY が起動していないため入力待ちにならない |
| done → running | 完了後に直接実行は不可。queued を経由する |
| done → failed | 一度完了したセッションは失敗にならない |
| failed → done | 失敗から直接完了にはできない。再実行（running 経由）が必要 |

---

## 8. データ保存

### 保存先一覧

| データ | 保存先 | 形式 | 説明 |
| :-- | :-- | :-- | :-- |
| セッション情報 | `~/.config/deck/sessions.json` | JSON | 全セッションのメタデータ（名前、状態、作業ディレクトリ等） |
| セッションログ | `~/.config/deck/logs/{session_id}.log` | テキスト | セッションごとに1ファイル。PTY 出力をそのまま記録 |
| アプリ設定 | `~/.config/deck/config.json`（想定） | JSON | タイムアウト秒数、ポーリング間隔、エディタ設定等 |
| br タスクデータ | 各プロジェクトの `.beads/beads.db` | SQLite（軽量データベース） | アプリは読み取りのみ。書き込みは行わない |

### セッション情報のフィールド

| フィールド | 型 | 説明 |
| :-- | :-- | :-- |
| id | UUID（一意識別子） | セッション固有 ID |
| name | 文字列 | ユーザー命名または自動採番（session-1 等） |
| root_path | ファイルパス | 作業ディレクトリ |
| status | 列挙型 | queued / running / needs_input / done / failed |
| pty_pid | 整数 or null | 実行中の PTY プロセス ID。未起動時は null |
| instruction | 文字列 | 最後に送った指示文 |
| log_path | ファイルパス | ログファイルのパス |
| exit_code | 整数 or null | PTY プロセスの終了コード |
| created_at | 日時 | セッション作成日時 |
| updated_at | 日時 | 最終更新日時 |

### ログファイルの構造

- 先頭にメタ情報（セッション名、作業ディレクトリ、開始時刻）を記録
- PTY 出力をそのまま追記（ANSI エスケープシーケンス（端末の色付け制御文字）含む）
- 統合ログ表示はファイルには書き込まない（表示上のマージのみ）
- セッション削除時にログファイルは自動削除しない（手動削除）

---

## 9. ユーザーインターフェース

### 画面構成

```
┌─────────────┬────────────────────────┬─────────────────┐
│ セッション    │ ファイル表示            │ ログ             │
│ 一覧         │                        │ (統合/個別切替)  │
│              │ 選択ファイルの内容表示   │                  │
│ [1] ● API   │ （閲覧専用）            │ session-1: ...   │
│ [2] ◆ Test  │                        │ session-2: ...   │
│ [3] ○ DB    │                        │ session-3: ...   │
│──────────────│                        │                  │
│ ディレクトリ  │                        │                  │
│ 📁 src/     │                        │                  │
│ 📁 .beads/  │                        │                  │
│ 📁 plans/   │                        │                  │
├─────────────┴────────────────────────┴─────────────────┤
│ [session-1] > タスクを実行して                           │
├─────────────────────────────────────────────────────────┤
│ 実行中: 2 │ 待機: 1 │ 完了: 3 │ エラー: 0 │ 入力待ち: 1 │
└─────────────────────────────────────────────────────────┘
```

### パネル一覧

| パネル | 位置 | 機能 |
| :-- | :-- | :-- |
| セッション一覧 | 左上 | セッションの状態アイコン・名前・作業ディレクトリ・更新時刻を一覧表示 |
| ディレクトリツリー | 左下 | 選択セッションの作業ディレクトリのファイル構造をツリー表示 |
| ファイル表示 | 中央 | 選択ファイルの内容をプレビュー表示（閲覧専用） |
| ログ | 右 | PTY 出力をリアルタイム表示。統合ログと個別ログを切替可能 |
| 指示入力欄 | 下部 | 選択セッションへの指示を入力。セッション名をプロンプトに表示 |
| ステータスバー | 最下部 | 状態別セッション数と操作ヒントを常時表示 |

### キーバインド

| キー | 機能 | 対象パネル |
| :-- | :-- | :-- |
| Ctrl+h/j/k/l | パネル間のフォーカス移動 | 全体 |
| ↑↓ | セッション選択 / ツリー移動 / ログスクロール | 各パネル |
| n | 新規セッション作成 | セッション一覧 |
| d | セッション削除（確認あり） | セッション一覧 |
| r | セッション名変更 | セッション一覧 |
| m | 手動で入力待ち状態に切替 | セッション一覧 |
| Enter | 指示送信 / フォルダ展開 / ファイル選択 | 入力欄 / ツリー |
| Ctrl+C | 選択セッションに SIGINT（中断）送信 | 入力欄 |
| Tab | 統合ログ ↔ 個別ログ切替 | ログ |
| / | ログ内テキスト検索 | ログ |
| e | 選択ファイルを $EDITOR で開く | ツリー / ファイル表示 |
| h | 隠しファイル表示トグル | ツリー |
| q | アプリ終了 | 全体 |

### 動作環境

| 項目 | 対応状況 |
| :-- | :-- |
| macOS ターミナル | 対応（主要対象） |
| Linux ターミナル | 対応 |
| Windows | 対象外（PTY の実装差異のため） |
| モバイル / タブレット | 対象外（ターミナルアプリケーションのため） |
| ブラウザ | 対象外 |
| 最小端末サイズ | 横120文字 × 縦30行（未満の場合は警告表示） |

---

## 10. セキュリティ・プライバシー

### 認証・アクセス制御

| 項目 | 内容 |
| :-- | :-- |
| 認証方式 | なし（ローカルターミナルアプリのため、OS のユーザー認証に依存） |
| ネットワーク公開 | なし（ネットワークポートを開かない。外部からのアクセス不可） |
| URL 漏洩時の影響 | 該当なし（Web アプリではないため URL が存在しない） |
| 不正利用への対策 | OS のファイルパーミッションで保護（~/.config/deck/ 配下） |

### ログ・プライバシー

| ログ項目 | 含まれるデータ | 保持期間 | 削除方法 |
| :-- | :-- | :-- | :-- |
| セッションログ | PTY 出力全文（Claude Code への指示内容、コード断片、ファイルパス等を含む可能性がある） | 無期限（自動削除なし） | ユーザーがログファイルを手動削除する（`~/.config/deck/logs/` 配下） |
| セッション情報 | セッション名、作業ディレクトリパス、最終指示文 | 無期限（自動削除なし） | sessions.json からセッションを削除する |

### プライバシーに関する注意事項

- ログファイルには Claude Code への指示内容がそのまま記録される。機密情報を含む指示を送信した場合、その内容がログファイルに残る
- ログファイルは OS のファイルパーミッション（ユーザーのみ読み書き可能）で保護されるが、暗号化は行わない
- br のデータベース（`.beads/beads.db`）は各プロジェクトディレクトリに存在し、deck はその内容を読み取る。deck がデータを外部に送信することはない

---

## 11. 外部サービス境界

### 外部依存一覧

| サービス | 障害時の挙動 | 検知方法 | 通知先 | 対応者 | 復旧手順 |
| :-- | :-- | :-- | :-- | :-- | :-- |
| Claude Code CLI | PTY プロセスが起動に失敗し、セッション状態が「失敗」になる。ログにエラーメッセージが表示される | 自動（PTY 起動失敗時に即座に検知） | ログパネル + ステータスバーに反映 | ユーザー自身 | `claude` コマンドのインストール状態を確認する。`claude --version` で動作確認し、必要に応じて再インストールする |
| br CLI | セッション一覧にタスク件数が表示されなくなる（空欄になる）。その他の機能には影響しない | 自動（`br list --json` のエラー応答で検知） | セッション一覧のタスク件数表示が消える | ユーザー自身 | br のインストール状態を確認する。`br --version` で動作確認し、必要に応じて再インストールする。br は任意依存のため、なくても deck の主要機能に影響しない |
| $EDITOR | ファイルのエディタ起動が失敗する。ファイルプレビュー（閲覧）は引き続き利用可能 | 自動（エディタプロセス起動失敗時に検知） | ログパネルにエラーメッセージを表示 | ユーザー自身 | 環境変数 $EDITOR を確認する。未設定の場合は `export EDITOR=vim` 等で設定する |

### FrankenTUI（ビルド依存）

| 項目 | 内容 |
| :-- | :-- |
| リスク | 初期段階のプロジェクト（GitHub Star 155、2026年2月時点）。API の破壊的変更やメンテナンス停止の可能性がある |
| 影響範囲 | ビルド時のみ（実行時にはネットワーク通信しない） |
| 対策 | Cargo.lock でバージョンを固定する。重大な API 変更時は Ratatui 等への移行を検討する |

---

## 12. 非機能要件

| 項目 | 基準値 | 計測方法 | 前提条件 |
| :-- | :-- | :-- | :-- |
| 画面描画遅延 | 100ms 以内 | PTY 出力受信からログパネルに表示されるまでの時間を、タイムスタンプ付きログで計測 | セッション数5以下、端末サイズ 120×30 以上 |
| ステータスバー更新遅延 | 1秒以内 | セッション状態変化（PTY 終了等）からステータスバーの数値反映までの時間を目視で確認 | 同上 |
| 同時セッション数 | 10セッション | 10セッションを同時に作成し、3セッションを同時実行して画面描画が崩れないことを確認 | macOS、メモリ 8GB 以上 |
| メモリ使用量 | 500MB 以下 | 3セッション同時実行状態で `ps aux` によりメモリ使用量（RSS: 物理メモリ使用量）を計測 | 各セッションのログが1万行以下 |
| アプリ起動時間 | 3秒以内 | `time deck` コマンドの real 時間を計測（セッション復元含む） | sessions.json に10セッション以下 |
| ログファイルサイズ上限 | 制限なし（仕様） | — | ディスク容量はユーザー管理。大量ログ時のパフォーマンス劣化は許容する |
| クラッシュ復旧 | ターミナル状態が復帰する | アプリを SIGKILL で強制終了し、ターミナルの表示（カーソル、エコー）が正常に戻ることを確認 | FrankenTUI の RAII（リソース自動解放機構）クリーンアップに依存 |

---

## 13. 監視・障害対応

### 監視対象

deck はローカルターミナルアプリケーションであり、サーバー監視は不要。アプリ内で以下を自己監視する。

| 監視対象 | 監視方法 | 異常時の表示 |
| :-- | :-- | :-- |
| PTY プロセスの生死 | イベントループ内で PTY の終了を検知 | セッション状態を done/failed に更新。ステータスバーに反映 |
| PTY 出力の停滞 | tick_every（100ms 間隔）で最終出力時刻を確認 | needs_input_timeout_sec 超過でセッション状態を needs_input に更新 |
| br CLI の応答 | ポーリング（デフォルト3秒間隔）で `br list --json` を実行 | エラー時はタスク件数表示を消す。ログには記録しない（ノイズ防止） |

### 障害対応

| 障害 | 影響 | 対応方法 |
| :-- | :-- | :-- |
| deck がクラッシュした | PTY プロセスは OS によって終了される。セッション情報は sessions.json に最後の保存時点で残る | deck を再起動する。セッション一覧は復元されるが、PTY プロセスは再接続できないため queued 状態にリセットされる |
| PTY プロセスがハングした | 特定のセッションが応答しなくなる。他のセッションには影響しない | Ctrl+C で SIGINT を送信する。回復しない場合は d キーでセッションを削除する（PTY プロセスも終了する） |
| sessions.json が破損した | セッション一覧が復元できない | sessions.json を手動で削除し、deck を再起動する。ログファイルは保持される |

---

## 14. 品質保証

### テスト方針（実装時に実施）

| テスト種類 | 対象 | 判定基準 |
| :-- | :-- | :-- |
| 単体テスト | Model の update 関数（状態遷移ロジック） | 全ての状態遷移パターン（セクション7の遷移条件 + 禁止遷移）がテストされている |
| 結合テスト | PTY 起動 → 出力受信 → 状態更新 の一連のフロー | PTY で echo コマンドを実行し、ログパネルに出力が表示されることを確認 |
| 手動テスト | 画面操作（パネル切替、キーバインド全種） | セクション9のキーバインド表の全操作が期待通りに動作する |
| 手動テスト | 異常系（claude 未インストール、ディレクトリ不在、PTY ハング） | セクション5の例外系に記載した挙動が再現される |

### 未実装時の制約

本設計書は設計フェーズで作成しており、コードベースが存在しない。以下は実装完了後に更新する。

- テスト通過率
- テストケース数
- カバレッジ

---

## 15. 納品物一覧・検収観点

| 納品物 | 受領形態 | 検収観点 | 責任範囲 | 更新要否 |
| :-- | :-- | :-- | :-- | :-- |
| ソースコード一式 | Git リポジトリ | `cargo build --release` でビルドが成功する | 開発者 | 機能追加・修正時 |
| 実行バイナリ | Git リポジトリの成果物 | macOS / Linux で起動し、セクション4の完成定義5条件を満たす | 開発者 | リリース時 |
| 基本設計書（本文書） | docs/2026-02-14_基本設計書.md | 設計と実装の整合性。コードと突合して矛盾がない | 開発者 | 設計変更時 |
| 計画書 | 0214_deck_plan.md | 参照用（設計の根拠として保持） | — | 更新不要 |
| テストコード | ソースコード内（tests/ 等） | `cargo test` で全テストが通過する | 開発者 | コード変更時 |

---

## 16. 運用・保守

### 日常運用

| 操作 | 方法 |
| :-- | :-- |
| アプリ起動 | ターミナルで `deck` コマンドを実行 |
| ログの確認 | `~/.config/deck/logs/` 配下のファイルを直接参照 |
| ログの削除 | `~/.config/deck/logs/` 配下のファイルを手動削除 |
| 設定変更 | `~/.config/deck/config.json` を直接編集（想定） |

### バックアップ

| 対象 | 方法 | 頻度 |
| :-- | :-- | :-- |
| sessions.json | ファイルコピー | 必要に応じて手動 |
| ログファイル | ファイルコピー | 必要に応じて手動 |
| ソースコード | Git リポジトリ | コミットごと |

自動バックアップ機能は搭載しない。ローカルファイルのため、OS のバックアップ機能（Time Machine 等）に委ねる。

---

## 17. 運用コスト概要

### 直接コスト

| 項目 | 課金モデル | 影響範囲 |
| :-- | :-- | :-- |
| deck 本体 | なし（ローカル実行） | — |
| Claude Code | Anthropic API の従量課金（Claude Code 利用規約に準拠） | deck は Claude Code の利用を便利にするツールであり、API 利用量は deck の有無にかかわらずユーザーの指示量に依存する |
| br CLI | なし（ローカル実行） | — |

### 注意事項

- deck は複数セッションの同時実行を容易にするため、**Claude Code の API 利用量が単一セッション利用時より増加する可能性がある**
- 認証はローカルアプリのため不要。ネットワーク公開しないため、不正利用によるコスト増大リスクはない

---

## 18. 変更管理

### 変更管理ルール

| 項目 | 内容 |
| :-- | :-- |
| 変更の申請 | Git Issue または計画書への追記 |
| 変更の承認 | 個人プロジェクトのため開発者自身が判断 |
| 影響範囲の確認 | 本設計書の該当セクションを確認し、矛盾がないか検証する |
| 版管理 | セマンティックバージョニング（MAJOR.MINOR.PATCH） |
| 設計書の更新 | 機能追加・変更時に本設計書も同時に更新する |

---

## 19. 変更履歴

| バージョン | 日付 | 変更内容 | 承認者 |
| :-- | :-- | :-- | :-- |
| 0.1.0 | 2026-02-14 | 初版作成（設計フェーズ版。計画書 `0214_deck_plan.md` を元に作成） | bonginkan_oka |
