# deck ユーザーガイド

複数の Claude Code セッションを1つのターミナル画面で統合管理する TUI アプリケーション。

## 前提条件

- **Rust nightly** がインストールされていること
- **Claude Code CLI** (`claude` コマンド) がインストール済みで、パスが通っていること
- macOS / Linux 環境

## インストール

```bash
# リポジトリをクローン
git clone <repo-url>
cd deck

# ビルド
make build

# リリースビルド（最適化あり）
make release
```

## 起動

```bash
# 開発モード
make run

# または直接実行
cargo run
```

初回起動時に設定ディレクトリ（`~/.config/deck/`）が自動作成される。

## 画面構成

deck の画面は以下の5つのパネルで構成されている。

```
+--------------------+--------------------+-----------------------+
| Session List       | File Preview       | Log                   |
| (セッション一覧)    | (ファイル表示)      | (出力ログ)             |
+                    +                    +                       +
| Dir Tree           |                    |                       |
| (ディレクトリツリー) |                    |                       |
+--------------------+--------------------+-----------------------+
| Input Bar (入力バー)                                             |
+----------------------------------------------------------------+
| Status Bar (ステータスバー)                                      |
+----------------------------------------------------------------+
```

| パネル | 説明 |
|--------|------|
| **Session List** | 作成したセッションの一覧。状態アイコンで各セッションの状況がわかる |
| **Dir Tree** | 選択中セッションの作業ディレクトリをツリー表示 |
| **File Preview** | ツリーで選択したファイルの中身をプレビュー（読み取り専用） |
| **Log** | セッションの出力ログ。Individual（個別）/ Unified（統合）モード切替可 |
| **Input Bar** | Claude Code への指示を入力する欄 |
| **Status Bar** | 全セッションの集計状態とキーヒントを表示 |

## セッションの状態

各セッションは以下の5つの状態を持つ。

| アイコン | 状態 | 意味 |
|----------|------|------|
| `○` | Queued | 作成直後。まだ指示を送っていない |
| `●` | Running | Claude Code が処理中 |
| `◆` | NeedsInput | Claude Code がユーザーの入力を待っている |
| `✓` | Done | 処理が正常に完了した |
| `✗` | Failed | エラーで終了した |

## キーバインド

### グローバル（どのパネルでも使える）

| キー | 動作 |
|------|------|
| `Tab` | 次のパネルへフォーカス移動 |
| `Ctrl+h` / `Ctrl+k` | 前のパネルへフォーカス移動 |
| `Ctrl+l` / `Ctrl+j` | 次のパネルへフォーカス移動 |
| `Ctrl+c` | 実行中セッションに SIGINT 送信。未実行なら終了 |
| `q` | アプリ終了（Input パネル以外） |

### Session List パネル

| キー | 動作 |
|------|------|
| `Up` / `Down` | セッション選択を上下に移動 |
| `n` | 新規セッションを作成 |
| `d` | 選択中のセッションを削除 |
| `r` | 選択中のセッション名を変更 |
| `m` | 入力待ち状態（NeedsInput）を手動で切り替え |

### Dir Tree パネル

| キー | 動作 |
|------|------|
| `Up` / `Down` | カーソル移動 |
| `Enter` | ディレクトリの展開/折りたたみ、ファイルならプレビュー表示 |
| `h` | 隠しファイル（`.` で始まるファイル）の表示/非表示を切替 |

### File Preview パネル

| キー | 動作 |
|------|------|
| `Up` / `Down` | スクロール |
| `e` | 外部エディタでファイルを開く |

### Log パネル

| キー | 動作 |
|------|------|
| `t` | Individual（個別ログ）/ Unified（全セッション統合ログ）モードを切替 |

### Input Bar パネル

| キー | 動作 |
|------|------|
| 文字入力 | テキストを入力 |
| `Backspace` | 1文字削除 |
| `Enter` | 入力内容を選択中のセッションに送信 |
| `Up` / `Down` | 入力履歴を遡る/進む |
| `Escape` | Session List パネルへフォーカスを戻す |

## 基本的な使い方

### 1. セッションを作成する

1. Session List パネルで `n` キーを押す
2. セッション名を入力して `Enter`（空でスキップすると `session-1` のような自動名称になる）
3. 作業ディレクトリのパスを入力して `Enter`（空で現在のディレクトリを使用）

### 2. Claude Code に指示を送る

1. `Tab` キーで Input Bar パネルへ移動
2. 指示を入力して `Enter`
3. PTY が自動的に起動し、Claude Code が実行される
4. 出力は Log パネルにリアルタイム表示される

### 3. 入力待ちに応答する

Claude Code が確認を求めている場合（`(y/n)` や `Do you want to...` など）:
- セッションが自動的に `NeedsInput` 状態（◆）になる
- Input Bar から回答を入力して `Enter`
- 30秒間出力がない場合もタイムアウトで `NeedsInput` に遷移する

### 4. 複数セッションを切り替える

- Session List パネルで `Up` / `Down` でセッションを選択
- 選択を切り替えると Dir Tree, File Preview, Log が自動的に連動する

### 5. ファイルを確認する

1. `Tab` で Dir Tree パネルへ移動
2. `Up` / `Down` でカーソル移動、`Enter` でディレクトリ展開
3. ファイルを選んで `Enter` → File Preview にプレビュー表示
4. `e` キーで外部エディタで開くこともできる

## 設定

設定ファイルは `~/.config/deck/` に保存される。

| ファイル | 内容 |
|----------|------|
| `sessions.json` | セッション情報の永続化 |
| `logs/` | 各セッションのログファイル（`<session-id>.log`） |

### 設定値

| 項目 | デフォルト値 | 説明 |
|------|-------------|------|
| `needs_input_timeout_sec` | 30 | 出力がない場合に NeedsInput に遷移するまでの秒数 |
| `br_poll_interval_sec` | 3 | br タスク情報のポーリング間隔（秒） |
| `editor` | 環境変数 `$EDITOR` または `vim` | ファイルプレビューから開くエディタ |

## データの永続化

- セッション一覧とステータスはアプリ終了時に `sessions.json` へ自動保存される
- ログは各セッションごとに `logs/<session-id>.log` に書き出される
- 再起動時にセッション一覧とログが復元される（PTY は `Queued` にリセットされる）

## トラブルシューティング

### `claude` コマンドが見つからない

```
Error: 'claude' command not found. Install Claude Code first.
```

Claude Code CLI がインストールされていないか、PATH が通っていない。`which claude` で確認し、必要に応じてインストールする。

### 作業ディレクトリが存在しない

```
Error: directory does not exist: /path/to/dir
```

セッション作成時に指定したディレクトリが削除されている。セッションを削除して新しいパスで再作成する。

### セッションが NeedsInput にならない

手動で `m` キーを押して状態を切り替えることができる。自動検知は出力に `(y/n)` や `confirm?` などのパターンが含まれる場合に動作する。
